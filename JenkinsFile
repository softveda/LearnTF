pipeline {
  agent any
  tools {
      terraform "Terraform"
  }
  environment {
    TF_IN_AUTOMATION = 'true'
    TFE_NAME = "app.terraform.io"
    TFE_URL = "https://app.terraform.io"
    TFE_ORGANIZATION = "learn-tf"
    TFE_API_URL = "${TFE_URL}/api/v2"
    TFE_API_TOKEN = credentials('tfe_api_token')
  }
 
  stages {
    stage('TFE Set-up') {
      steps{
          sh '''
                sh 'printenv'
                tee ~/.terraformrc > /dev/null <<EOF
                credentials "${TFE_NAME}" {
                  token        = "${TFE_API_TOKEN}"
                }
EOF
          '''
      }
    }
    stage('TFE Workspaces list ') {
      steps {
          sh '''
            curl \
              --silent --show-error --fail \
              --header "Authorization: Bearer ${TFE_API_TOKEN}" \
              --header "Content-Type: application/vnd.api+json" \
              ${TFE_API_URL}/organizations/${TFE_ORGANIZATION}/workspaces \
              | jq -r \'.data[] | .attributes.name\'
          '''
      }
    }
    stage('Terraform Init') {
      steps {
        sh "terraform init -input=false -no-color"
      }
    }
    stage('Terraform Plan') {
      steps {
        sh "terraform plan -out=tfplan -input=false -var-file='terraform.tfvars' -no-color"
      }
    }
    stage('Terraform Apply') {
      steps {
        input 'Apply Plan'
        sh "terraform apply -input=false tfplan -no-color"
      }
    }
  }
}